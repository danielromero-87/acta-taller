<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acta de Entrega de Vehículo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 20px;
            color: #333;
        }
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h4 {
            text-align: center;
            color: #2646d3;
        }
        .section {
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .section:last-child {
            border-bottom: none;
        }
        .form-group {
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .form-group label {
            flex: 0 0 150px;
            font-weight: bold;
            margin-right: 10px;
        }
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group textarea,
        .form-group select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            min-width: 200px; /* Ensure inputs are not too small */
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        .signature-pad {
            border: 1px solid #487fef;
            background-color: #f9f9f9;
            cursor: crosshair;
            margin-top: 10px;
        }
        .signature-buttons {
            text-align: center;
            margin-top: 5px;
        }
        .signature-buttons button {
            padding: 8px 15px;
            margin: 0 5px;
            background-color: #2646d3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .signature-buttons button:hover {
            background-color: #f95a28;
        }
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
            padding-left: 10px;
        }
        .checkbox-group label {
            font-weight: normal;
        }
        .otros-text-input {
            width: calc(100% - 20px); /* Adjust width as needed */
            margin-top: 5px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .selected-services-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            min-height: 40px;
            background-color: #f9f9f9;
        }
        .service-tag {
            background-color: #2646d3;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
        }
        .add-service-button {
            padding: 8px 15px;
            background-color: #2646d3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .add-service-button:hover {
            background-color: #f95a28;
        }
        .full-width {
            flex: 1 1 100%;
        }

        /* Print-specific styles */
        @media print {
            body {
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact; /* For background colors/images */
            }
            .container {
                border: none;
                box-shadow: none;
                padding: 0;
                margin: 0;
                width: 100%;
                max-width: none;
            }
            .signature-buttons, .add-service-button {
                display: none; /* Hide buttons when printing */
            }
            .signature-pad {
                border: 1px solid #000; /* Ensure border is visible on print */
            }
            input, textarea, select {
                border: none; /* Remove borders for cleaner print */
                background: none;
                padding: 0;
            }
            .form-group label {
                font-weight: bold;
            }
            /* Ensure content fits on one page */
            html, body {
                height: 100%;
                overflow: hidden;
            }
            .section {
                page-break-inside: avoid; /* Avoid breaking sections across pages */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 20px;">
            <img src="imagenes/MEMBRETE_HEADER.png" alt="Membrete de la Empresa" style="max-width: 100%; height: auto;">
        </div>
        <h1>Acta de Entrega de Vehículo</h1>
                <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="deliveryDate">Fecha:</label>
                <input type="date" id="deliveryDate">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="quoteNumber">No. Cotización:</label>
                <input type="text" id="quoteNumber">
            </div>
        </div>

        <div class="section">
            <h2>Datos del Cliente</h2>
            <div class="form-group">
                <label for="clientName">Nombre Completo:</label>
                <input type="text" id="clientName">
            </div>
            <div class="form-group">
                <label for="clientId">Cédula/NIT:</label>
                <input type="text" id="clientId">
            </div>
            <div class="form-group">
                <label for="clientAddress">Dirección:</label>
                <input type="text" id="clientAddress">
            </div>
            <div class="form-group">
                <label for="clientPhone">Teléfono:</label>
                <input type="text" id="clientPhone">
            </div>
            <div class="form-group">
                <label for="clientEmail">Email:</label>
                <input type="text" id="clientEmail">
            </div>
        </div>

        <div class="section">
            <h2>Datos del Vehículo</h2>
            <div class="form-group">
                <label for="vehicleMake">Marca:</label>
                <input type="text" id="vehicleMake">
            </div>
            <div class="form-group">
                <label for="vehicleLine">Línea:</label>
                <input type="text" id="vehicleLine">
            </div>
            <div class="form-group">
                <label for="vehicleModel">Modelo:</label>
                <input type="text" id="vehicleModel">
            </div>
            <div class="form-group">
                <label for="vehicleColor">Color:</label>
                <input type="text" id="vehicleColor">
            </div>
            <div class="form-group">
                <label for="vehiclePlate">Placa:</label>
                <input type="text" id="vehiclePlate">
            </div>
            <div class="form-group">
                <label for="vehicleKm">KM:</label>
                <input type="text" id="vehicleKm">
            </div>
            <div class="form-group">
                <label for="vehicleVin">VIN:</label>
                <input type="text" id="vehicleVin">
            </div>
            <div class="form-group">
                <label for="vehicleEngineNum"># Motor:</label>
                <input type="text" id="vehicleEngineNum">
            </div>
        </div>

        <div class="section">
            <h2>Servicios Realizados</h2>
            <div class="form-group">
                <label for="serviceCategory">Categoría de Servicio:</label>
                <select id="serviceCategory">
                    <option value="">-- Seleccione una categoría --</option>
                    <option value="latoneria_y_pintura">LATONERÍA Y PINTURA</option>
                    <option value="limpieza">LIMPIEZA</option>
                    <option value="mecanica">MECÁNICA</option>
                    <option value="partes_accesorios">PARTES Y ACCESORIOS</option>
                </select>
            </div>

            <!-- Contenedores de Checkboxes para cada categoría -->
            <div id="latoneria_y_pintura_services" class="service-options" style="display:none;">
                <h4>LATONERÍA Y PINTURA</h4>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="service" value="Latonería y pintura bómper delantero"> Latonería y pintura bómper delantero</label>
                    <label><input type="checkbox" name="service" value="Latonería y pintura bómper trasero"> Latonería y pintura bómper trasero</label>
                    <label><input type="checkbox" name="service" value="Latonería y pintura capó"> Latonería y pintura capó</label>
                    <label><input type="checkbox" name="service" value="Latonería y pintura puertas (especificar puerta)"> Latonería y pintura puertas (especificar puerta)</label>
                    <label><input type="checkbox" name="service" value="Latonería y pintura puerta baúl"> Latonería y pintura puerta baúl</label>
                    <label><input type="checkbox" name="service" value="Latonería y pintura estribo derecho"> Latonería y pintura estribo derecho</label>
                    <label><input type="checkbox" name="service" value="Latonería y pintura estribo izquierdo"> Latonería y pintura estribo izquierdo</label>
                    <label><input type="checkbox" name="service" value="Latonería y pintura costado delantero derecho"> Latonería y pintura costado delantero derecho</label>
                    <label><input type="checkbox" name="service" value="Latonería y pintura costado delantero izquierdo"> Latonería y pintura costado delantero izquierdo</label>
                    <label><input type="checkbox" name="service" value="Latonería y pintura costado trasero derecho"> Latonería y pintura costado trasero derecho</label>
                    <label><input type="checkbox" name="service" value="Latonería y pintura costado trasero izquierdo"> Latonería y pintura costado trasero izquierdo</label>
                    <label><input type="checkbox" name="service" value="Reparación partes negras"> Reparación partes negras</label>
                    <label><input type="checkbox" name="service" value="Diamantado o pintura de rines"> Diamantado o pintura de rines</label>
                    <label><input type="checkbox" name="service" value="Polichado básico"> Polichado básico</label>
                    <label><input type="checkbox" name="service" value="Porcelanizado"> Porcelanizado</label>
                    <div>
                        <label><input type="checkbox" class="otros-check" id="latoneria_y_pintura_otros_check" name="service" value="Otros"> Otros</label>
                        <input type="text" id="latoneria_y_pintura_otros_text" class="otros-text-input" style="display:none;" placeholder="Especificar otros...">
                    </div>
                </div>
            </div>

            <div id="limpieza_services" class="service-options" style="display:none;">
                <h4>LIMPIEZA</h4>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="service" value="Lavado general"> Lavado general</label>
                    <label><input type="checkbox" name="service" value="Lavado de motor"> Lavado de motor</label>
                    <label><input type="checkbox" name="service" value="Lavado de chasis"> Lavado de chasis</label>
                    <label><input type="checkbox" name="service" value="Limpieza de tapicería"> Limpieza de tapicería</label>
                    <label><input type="checkbox" name="service" value="Limpieza de techo"> Limpieza de techo</label>
                    <label><input type="checkbox" name="service" value="Grafitado"> Grafitado</label>
                    <label><input type="checkbox" name="service" value="Desinfección de ductos"> Desinfección de ductos</label>
                    <div>
                        <label><input type="checkbox" class="otros-check" id="limpieza_otros_check" name="service" value="Otros"> Otros</label>
                        <input type="text" id="limpieza_otros_text" class="otros-text-input" style="display:none;" placeholder="Especificar otros servicios de limpieza...">
                    </div>
                </div>
            </div>

            <div id="mecanica_services" class="service-options" style="display:none;">
                <h4>MECÁNICA</h4>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="service" value="Cambio de aceite de motor"> Cambio de aceite de motor</label>
                    <label><input type="checkbox" name="service" value="Cambio de filtro de aceite"> Cambio de filtro de aceite</label>
                    <label><input type="checkbox" name="service" value="Cambio de filtro de aire"> Cambio de filtro de aire</label>
                    <label><input type="checkbox" name="service" value="Cambio de filtro de aire acondicionado"> Cambio de filtro de aire acondicionado</label>
                    <label><input type="checkbox" name="service" value="Líquido de frenos"> Líquido de frenos</label>
                    <label><input type="checkbox" name="service" value="Cambio de pastillas de freno delantero"> Cambio de pastillas de freno delantero</label>
                    <label><input type="checkbox" name="service" value="Cambio de pastillas de freno trasero"> Cambio de pastillas de freno trasero</label>
                    <label><input type="checkbox" name="service" value="Cambio de discos de freno delantero"> Cambio de discos de freno delantero</label>
                    <label><input type="checkbox" name="service" value="Cambio de discos de freno trasero"> Cambio de discos de freno trasero</label>
                    <label><input type="checkbox" name="service" value="Cambio de batería"> Cambio de batería</label>
                    <label><input type="checkbox" name="service" value="Cambio de soportes de motor"> Cambio de soportes de motor</label>
                    <label><input type="checkbox" name="service" value="Revisión de fugas"> Revisión de fugas</label>
                    <label><input type="checkbox" name="service" value="Revisión general"> Revisión general</label>
                    <label><input type="checkbox" name="service" value="Servicio de escáner"> Servicio de escáner</label>
                    <label><input type="checkbox" name="service" value="Amortiguadores (indicar en comentarios)"> Amortiguadores (indicar en comentarios)</label>
                    <div>
                        <label><input type="checkbox" class="otros-check" id="mecanica_otros_check" name="service" value="Otros"> Otros</label>
                        <input type="text" id="mecanica_otros_text" class="otros-text-input" style="display:none;" placeholder="Especificar otros servicios de mecánica...">
                    </div>
                </div>
            </div>

            <div id="partes_accesorios_services" class="service-options" style="display:none;">
                <h4>PARTES Y ACCESORIOS</h4>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="service" value="Suministro de partes de carrocería (especificar en comentarios)"> Suministro de partes de carrocería (especificar en comentarios)</label>
                    <label><input type="checkbox" name="service" value="Llantas (ingresar referencia en comentarios)"> Llantas (ingresar referencia en comentarios)</label>
                    <label><input type="checkbox" name="service" value="Accesorios deportivos (especificar en comentarios)"> Accesorios deportivos (especificar en comentarios)</label>
                    <label><input type="checkbox" name="service" value="Polarizado de vidrios"> Polarizado de vidrios</label>
                    <label><input type="checkbox" name="service" value="Pantalla digital (Apple CarPlay - Android Auto o Apple CarPlay Ultra)"> Pantalla digital (Apple CarPlay - Android Auto o Apple CarPlay Ultra)</label>
                    <label><input type="checkbox" name="service" value="Vidrio panorámico frontal"> Vidrio panorámico frontal</label>
                    <label><input type="checkbox" name="service" value="Vidrio panorámico posterior"> Vidrio panorámico posterior</label>
                    <label><input type="checkbox" name="service" value="Vidrios laterales o custodios"> Vidrios laterales o custodios</label>
                    <label><input type="checkbox" name="service" value="Vinilos decorativos"> Vinilos decorativos</label>
                    <label><input type="checkbox" name="service" value="Tapicería de sillas (ingresar referencias)"> Tapicería de sillas (ingresar referencias)</label>
                    <label><input type="checkbox" name="service" value="Arreglo de manija de puertas"> Arreglo de manija de puertas</label>
                    <label><input type="checkbox" name="service" value="Tapa de enganche (delantera o trasera especificar en comentarios)"> Tapa de enganche (delantera o trasera especificar en comentarios)</label>
                    <label><input type="checkbox" name="service" value="Cambio de plumillas"> Cambio de plumillas</label>
                    <label><input type="checkbox" name="service" value="Duplicado de llave"> Duplicado de llave</label>
                    <label><input type="checkbox" name="service" value="Blindaje (2, 2+, 3)"> Blindaje (2, 2+, 3)</label>
                    <div>
                        <label><input type="checkbox" class="otros-check" id="partes_accesorios_otros_check" name="service" value="Otros"> Otros</label>
                        <input type="text" id="partes_accesorios_otros_text" class="otros-text-input" style="display:none;" placeholder="Especificar otras partes o accesorios...">
                    </div>
                </div>
            </div>

            <div class="section">
                <h4>Servicios Seleccionados</h4>
                <div id="selectedServicesList" class="selected-services-container"></div>
            </div>

            <div class="form-group full-width" style="margin-top: 15px;">
                <label for="serviceObservations">Observaciones del Servicio:</label>
                <textarea id="serviceObservations"></textarea>
            </div>
        </div>

        <div class="section">
            <h2>Estado del Vehículo a la Entrega</h2>
            <div class="form-group full-width">
                <label for="deliveryCondition">Condiciones Generales:</label>
                <textarea id="deliveryCondition"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="deliveryItemSelect">Elementos Entregados:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="deliveryItemSelect" style="flex: 1;">
                        <option value="">-- Seleccione un elemento --</option>
                        <option value="Llave">Llave</option>
                        <option value="Documentos del vehículo">Documentos del vehículo</option>
                        <option value="Perno de seguridad y enganche">Perno de seguridad y enganche</option>
                        <option value="Kit de carretera">Kit de carretera</option>
                        <option value="Botiquín y extintor">Botiquín y extintor</option>
                        <option value="Otros">Otros</option>
                    </select>
                    <input type="text" id="delivery_item_otros_text" style="display:none; flex: 1;" placeholder="Especificar otro elemento...">
                    <button id="addDeliveryItemBtn" class="add-service-button">Añadir</button>
                </div>
            </div>
            <div class="form-group full-width">
                <label>Resumen:</label>
                <div id="selectedDeliveryItemsList" class="selected-services-container" style="flex: 1;"></div>
            </div>
        </div>

        <div class="section">
            <h2>Firmas</h2>
            <div style="display: flex; justify-content: space-around; margin-top: 30px;">
                <div style="text-align: center;">
                    <p>Firma del Cliente</p>
                    <canvas id="signatureClient" class="signature-pad" width="300" height="150"></canvas>
                    <div class="signature-buttons">
                        <button onclick="clearSignature('signatureClient')">Borrar</button>
                    </div>
                </div>
                <div style="text-align: center;">
                    <p>Firma del Responsable</p>
                    <canvas id="signatureResponsible" class="signature-pad" width="300" height="150"></canvas>
                    <div class="signature-buttons">
                        <button onclick="clearSignature('signatureResponsible')">Borrar</button>
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button id="sendButton" class="add-service-button" style="padding: 15px 30px; font-size: 18px;">Enviar</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('deliveryDate').value = `${yyyy}-${mm}-${dd}`;

            // Service Category Logic
            const serviceCategorySelect = document.getElementById('serviceCategory');
            serviceCategorySelect.addEventListener('change', function() {
                document.querySelectorAll('.service-options').forEach(div => {
                    div.style.display = 'none';
                });
                const selectedCategory = this.value;
                if (selectedCategory) {
                    const servicesDiv = document.getElementById(selectedCategory + '_services');
                    if (servicesDiv) {
                        servicesDiv.style.display = 'block';
                    }
                }
            });

            // "Otros" Checkbox Logic
            document.querySelectorAll('.otros-check').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const textInputId = this.id.replace('_check', '_text');
                    const textInput = document.getElementById(textInputId);
                    if (textInput) {
                        textInput.style.display = this.checked ? 'block' : 'none';
                    }
                });
            });

            // Selected Services Summary Logic
            function updateSelectedServices() {
                const listContainer = document.getElementById('selectedServicesList');
                if (!listContainer) return;
                listContainer.innerHTML = ''; // Clear the list

                const checkedServices = document.querySelectorAll('input[name="service"]:checked');

                checkedServices.forEach(checkbox => {
                    let serviceName = '';
                    if (checkbox.value === 'Otros') {
                        const textInputId = checkbox.id.replace('_check', '_text');
                        const textInput = document.getElementById(textInputId);
                        if (textInput && textInput.value.trim() !== '') {
                            serviceName = textInput.value.trim();
                        }
                    } else {
                        serviceName = checkbox.value;
                    }

                    if (serviceName) {
                        const tag = document.createElement('span');
                        tag.className = 'service-tag';
                        tag.textContent = serviceName;
                        tag.title = 'Click para eliminar';
                        tag.style.cursor = 'pointer';

                        tag.addEventListener('click', function() {
                            checkbox.checked = false;
                            if (checkbox.value === 'Otros') {
                                const textInputId = checkbox.id.replace('_check', '_text');
                                const textInput = document.getElementById(textInputId);
                                if (textInput) {
                                    textInput.value = '';
                                }
                            }
                            checkbox.dispatchEvent(new Event('change'));
                        });

                        listContainer.appendChild(tag);
                    }
                });
            }

            // Add event listeners to all service checkboxes
            document.querySelectorAll('input[name="service"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedServices);
            });

            // Add event listeners to all "Otros" text inputs
            document.querySelectorAll('.otros-text-input').forEach(input => {
                input.addEventListener('input', updateSelectedServices);
            });

            // --- Logic for "Elementos Entregados" Dropdown ---

            const selectedDeliveryItems = new Set();
            const deliveryItemSelect = document.getElementById('deliveryItemSelect');
            const otrosDeliveryInput = document.getElementById('delivery_item_otros_text');
            const addDeliveryItemBtn = document.getElementById('addDeliveryItemBtn');
            const selectedDeliveryItemsList = document.getElementById('selectedDeliveryItemsList');

            function renderDeliveryItems() {
                selectedDeliveryItemsList.innerHTML = '';
                selectedDeliveryItems.forEach(item => {
                    const tag = document.createElement('span');
                    tag.className = 'service-tag';
                    tag.textContent = item;
                    tag.title = 'Click para eliminar';
                    tag.style.cursor = 'pointer';
                    tag.addEventListener('click', () => {
                        selectedDeliveryItems.delete(item);
                        renderDeliveryItems();
                    });
                    selectedDeliveryItemsList.appendChild(tag);
                });
            }

            if (deliveryItemSelect) {
                deliveryItemSelect.addEventListener('change', () => {
                    if (deliveryItemSelect.value === 'Otros') {
                        otrosDeliveryInput.style.display = 'block';
                    } else {
                        otrosDeliveryInput.style.display = 'none';
                    }
                });
            }

            if (addDeliveryItemBtn) {
                addDeliveryItemBtn.addEventListener('click', () => {
                    let selectedValue = deliveryItemSelect.value;
                    let itemToAdd = null;

                    if (selectedValue === 'Otros') {
                        itemToAdd = otrosDeliveryInput.value.trim();
                    } else if (selectedValue) {
                        itemToAdd = selectedValue;
                    }

                    if (itemToAdd) {
                        selectedDeliveryItems.add(itemToAdd);
                        renderDeliveryItems();
                    }

                    // Reset inputs
                    deliveryItemSelect.value = '';
                    otrosDeliveryInput.value = '';
                    otrosDeliveryInput.style.display = 'none';
                });
            }

            renderDeliveryItems(); // Initial render

            // --- Logic for Sending Form Data to Google Sheet ---

            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.addEventListener('click', async () => {
                    // Collect all form data
                    const formData = {
                        deliveryDate: document.getElementById('deliveryDate').value,
                        quoteNumber: document.getElementById('quoteNumber').value,
                        clientName: document.getElementById('clientName').value,
                        clientId: document.getElementById('clientId').value,
                        clientAddress: document.getElementById('clientAddress').value,
                        clientPhone: document.getElementById('clientPhone').value,
                        clientEmail: document.getElementById('clientEmail').value,
                        vehicleMake: document.getElementById('vehicleMake').value,
                        vehicleLine: document.getElementById('vehicleLine').value,
                        vehicleModel: document.getElementById('vehicleModel').value,
                        vehicleColor: document.getElementById('vehicleColor').value,
                        vehiclePlate: document.getElementById('vehiclePlate').value,
                        vehicleKm: document.getElementById('vehicleKm').value,
                        vehicleVin: document.getElementById('vehicleVin').value,
                        vehicleEngineNum: document.getElementById('vehicleEngineNum').value,
                        serviceObservations: document.getElementById('serviceObservations').value,
                        deliveryCondition: document.getElementById('deliveryCondition').value,
                        // Collect selected services
                        selectedServices: Array.from(document.querySelectorAll('#selectedServicesList .service-tag')).map(tag => tag.textContent).join(', '),
                        // Collect selected delivery items
                        selectedDeliveryItems: Array.from(document.querySelectorAll('#selectedDeliveryItemsList .service-tag')).map(tag => tag.textContent).join(', '),
                        // Get signature data URLs
                        signatureClient: document.getElementById('signatureClient').toDataURL('image/png'),
                        signatureResponsible: document.getElementById('signatureResponsible').toDataURL('image/png')
                    };

                    // Google Apps Script Web App URL
                    const scriptUrl = 'https://script.google.com/macros/s/AKfycbxAd4MRqGCgdAbehPiKlvU7KDUr-eUb6tkc66p4141UVS2ZgswWpguM50TCw1AQYteT/exec';

                    try {
                        const response = await fetch(scriptUrl, {
                            method: 'POST',
                            mode: 'no-cors', // Required for Apps Script web app
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });

                        // Since mode is 'no-cors', we can't directly read the response.
                        // We assume success if no network error.
                        alert('Formulario enviado con éxito. Revisa tu Google Sheet.');
                        // Optionally, clear the form here
                        // document.querySelector('form').reset(); // If you wrap everything in a form tag
                        // Or manually clear fields
                        // location.reload(); // To clear everything and start fresh

                    } catch (error) {
                        console.error('Error al enviar el formulario:', error);
                        alert('Hubo un error al enviar el formulario. Por favor, inténtalo de nuevo.');
                    }
                });
            }

            // Signature Pad Logic (unchanged)
            const signaturePads = {};
            const canvases = document.querySelectorAll('.signature-pad');
            canvases.forEach(canvas => {
                const ctx = canvas.getContext('2d');
                let drawing = false;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = 'black';
                function getMousePos(canvas, evt) {
                    const rect = canvas.getBoundingClientRect();
                    return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
                }
                function getTouchPos(canvas, touch) {
                    const rect = canvas.getBoundingClientRect();
                    return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
                }
                canvas.addEventListener('mousedown', (e) => {
                    drawing = true;
                    const pos = getMousePos(canvas, e);
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                });
                canvas.addEventListener('mousemove', (e) => {
                    if (!drawing) return;
                    const pos = getMousePos(canvas, e);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                });
                canvas.addEventListener('mouseup', () => {
                    drawing = false;
                    ctx.closePath();
                });
                canvas.addEventListener('mouseout', () => {
                    if (drawing) {
                        drawing = false;
                        ctx.closePath();
                    }
                });
                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    drawing = true;
                    const touch = e.touches[0];
                    const pos = getTouchPos(canvas, touch);
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                });
                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (!drawing) return;
                    const touch = e.touches[0];
                    const pos = getTouchPos(canvas, touch);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                });
                canvas.addEventListener('touchend', () => {
                    drawing = false;
                    ctx.closePath();
                });
                signaturePads[canvas.id] = ctx;
            });
        });

        // Unchanged clearSignature function
        function clearSignature(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    </script>
</body>
</html>